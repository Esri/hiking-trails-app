import{fR as v,O as $,aC as p,fS as M,fT as d,fU as h,fV as g,fW as y,am as w,fX as I}from"./index-r0Ml_rWi.js";import{u as S,c as m,i as O,f as x}from"./PointCloudWorkerUtil-C4s-plpp.js";import"./PointCloudUniqueValueRenderer-FFDHRVeH.js";import"./I3SBinaryReader-0GkU4uRx.js";class F{transform(t){const a=this._transform(t),e=[a.points.buffer,a.rgb.buffer];a.pointIdFilterMap!=null&&e.push(a.pointIdFilterMap.buffer);for(const o of a.attributes)"buffer"in o.values&&v(o.values.buffer)&&o.values.buffer!==a.rgb.buffer&&e.push(o.values.buffer);return Promise.resolve({result:a,transferList:e})}_transform(t){const a=S(t.schema,t.geometryBuffer);let e=a.length/3,o=null;const u=new Array,f=m(t.primaryAttributeData,a,e);t.primaryAttributeData!=null&&f&&u.push({attributeInfo:t.primaryAttributeData.attributeInfo,values:f});const i=m(t.modulationAttributeData,a,e);t.modulationAttributeData!=null&&i&&u.push({attributeInfo:t.modulationAttributeData.attributeInfo,values:i});let r=O(t.rendererInfo,f,i,e);if(t.filterInfo&&t.filterInfo.length>0&&t.filterAttributesData!=null){const l=t.filterAttributesData.filter($).map(n=>{const D=m(n,a,e),c={attributeInfo:n.attributeInfo,values:D};return u.push(c),c});o=new Uint32Array(e),e=x(a,r,o,t.filterInfo,l)}for(const l of t.userAttributesData){const n=m(l,a,e);u.push({attributeInfo:l.attributeInfo,values:n})}3*e<r.length&&(r=new Uint8Array(r.buffer.slice(0,3*e))),U(a,e,t.elevationOffset);const b=R(a,e,M.fromData(t.obbData),p.fromJSON(t.inSR),p.fromJSON(t.outSR));return{obbData:t.obbData,points:b,rgb:r,attributes:u,pointIdFilterMap:o}}}function R(s,t,a,e,o){if(!d(s,e,0,s,o,0,t))throw new Error("Can't reproject");const u=h(a.center),f=I(),i=I(),r=h(a.halfSize);g(A,a.quaternion);const b=new Float32Array(3*t);for(let l=0;l<t;l++){let n=3*l;f[0]=s[n]-u[0],f[1]=s[n+1]-u[1],f[2]=s[n+2]-u[2],y(i,f,A),r[0]=Math.max(r[0],Math.abs(i[0])),r[1]=Math.max(r[1],Math.abs(i[1])),r[2]=Math.max(r[2],Math.abs(i[2])),b[n++]=f[0],b[n++]=f[1],b[n]=f[2]}return a.halfSize=r,b}function U(s,t,a){if(a!==0)for(let e=0;e<t;e++)s[3*e+2]+=a}const A=w();function N(){return new F}export{N as default};
