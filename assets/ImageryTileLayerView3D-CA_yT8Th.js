import{no as R,np as G,nq as L,nr as M,ns as b,i9 as z,nt as E,nu as O,nv as f,nw as U,e as d,y as p,k as $,s as j,av as V,bG as k,nx as W}from"./index-r0Ml_rWi.js";import{v as J,s as v}from"./rasterProjectionHelper-g53nf9wy.js";import{l as Z}from"./LayerView3D-D72Vr-Z0.js";import{p as q}from"./TiledLayerView3D-DNjBCfcF.js";import{i as H}from"./timeSupport-W1jIjBlk.js";import{p as Y}from"./popupUtils-Di_dO6dW.js";import{y as Q}from"./LayerView-DKnidSo3.js";import{i as K}from"./RefreshableLayerView-DIAp9UEp.js";import{r as X}from"./drapedUtils-CEt32m0Z.js";function ee(r,e,t="nearest",i=!1){const s=!(i&&e.pixelType==="u8"),n=s?R.FLOAT:R.UNSIGNED_BYTE,h=e.pixels==null||e.pixels.length===0?null:s?e.getAsRGBAFloat():e.getAsRGBA(),m=r.capabilities.textureFloatLinear,a=new G;return a.width=e.width,a.height=e.height,a.internalFormat=s?L.RGBA32F:M.RGBA,a.samplingMode=!m||t!=="bilinear"&&t!=="cubic"?b.NEAREST:b.LINEAR,a.dataType=n,a.wrapMode=z.CLAMP_TO_EDGE,new E(r,a,h)}function te(r,e){const{spacing:t,offsets:i,coefficients:s,size:[n,h]}=e,m=t[0]>1,a=new G;a.width=m?4*n:n,a.height=h,a.internalFormat=L.RGBA32F,a.dataType=R.FLOAT,a.samplingMode=b.NEAREST,a.wrapMode=z.CLAMP_TO_EDGE;const l=new Float32Array(m?n*h*16:2*i.length);if(m&&s!=null)for(let u=0,o=0;u<s.length;u++)l[o++]=s[u],u%3==2&&(l[o++]=1);else for(let u=0;u<h;u++)for(let o=0;o<n;o++){const _=4*(u*n+o),c=2*(o*h+u);l[_]=i[c],l[_+1]=i[c+1],l[_+3]=i[c]===-1?0:1}return new E(r,a,l)}function C(r,e){const t=new G;return t.internalFormat=M.RGBA,t.width=e.length/4,t.height=1,t.samplingMode=b.NEAREST,t.wrapMode=z.CLAMP_TO_EDGE,new E(r,t,e)}function re(r,e,t,i=1,s=!0){return{u_flipY:s,u_applyTransform:!!r,u_opacity:i,u_transformSpacing:r?r.spacing:O,u_transformGridSize:r?r.size:O,u_targetImageSize:e,u_srcImageSize:t}}function ie(r,e){return{u_colormapOffset:e||0,u_colormapMaxIndex:r?r.length/4-1:0}}function se(r){return{u_bandCount:r.bandCount,u_minOutput:r.outMin,u_maxOutput:r.outMax,u_minCutOff:r.minCutOff,u_maxCutOff:r.maxCutOff,u_factor:r.factor,u_useGamma:r.useGamma,u_gamma:r.gamma,u_gammaCorrection:r.gammaCorrection}}function ae(r){return{u_hillshadeType:r.hillshadeType,u_sinZcosAs:r.sinZcosAs,u_sinZsinAs:r.sinZsinAs,u_cosZs:r.cosZs,u_weights:r.weights,u_factor:r.factor,u_minValue:r.minValue,u_maxValue:r.maxValue}}const F={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class ne{constructor(e,t,i=null,s=null){this.lij=e,this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.opacity=1,this.source=t,this.width=i||t.width,this.height=s||t.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture=f(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...F,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||F}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){e!=null&&e.length>0?this._bandIds&&e.every((t,i)=>{var s;return!!((s=this._bandIds)!=null&&s[i])&&t===this._bandIds[i]})||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,this._rasterTexture!=null){const t=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode(t==="bilinear"?b.LINEAR:b.NEAREST)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=f(this._transformGridTexture),this._memoryUsed=null}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((this._rasterTexture==null||this._dirty)&&this._updateRasterTexture(e,this.bandIds),this._rasterTexture!=null&&(this._updateColormapTexture(e),this.transformGrid&&this._transformGridTexture==null&&(this._transformGridTexture=te(e,this.transformGrid))),!0)}getUniforms(){const{symbolizerParameters:e,transformGrid:t,width:i,height:s,opacity:n}=this,h=re(t,[i,s],[this.source.width,this.source.height],n),m=ie(e.colormap,e.colormapOffset),a=this.symbolizerParameters.type==="stretch"?se(this.symbolizerParameters):null,l=this.symbolizerParameters.type==="hillshade"?ae(this.symbolizerParameters):null;return new U(h,m,a||l,this._rasterTexture,this._transformGridTexture,this._colormapTexture)}get isBilinearWithStretchColorRamp(){const{symbolizerParameters:e}=this;return this.interpolation==="bilinear"&&e.colormap!=null&&e.type==="stretch"}get memoryUsage(){if(this._memoryUsed==null){const e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map(t=>t!=null?t.descriptor.width*t.descriptor.height*4:0).reduce((t,i)=>t+i,0)}return this._memoryUsed}release(){return this._rasterTexture=f(this._rasterTexture),this._transformGridTexture=f(this._transformGridTexture),this._colormapTexture=f(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,t){const i=this.source?this.source.extractBands(t):null;if(!(i!=null&&i.pixels&&i.pixels.length>0))return void(this._rasterTexture=f(this._rasterTexture));const s=t==null&&this.bandIds==null||t!=null&&this.bandIds!=null&&t.join("")===this.bandIds.join("");if(this._rasterTexture!=null&&s)return;this._rasterTexture=f(this._rasterTexture);const n=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=ee(e,i,n,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(e){return this.symbolizerParameters.type==="lut"||e==="nearest"||e==="majority"||this.isBilinearWithStretchColorRamp?"nearest":"bilinear"}_updateColormapTexture(e){const t=this._colormap,i=this.symbolizerParameters.colormap;return i?t?i.length!==t.length||i.some((s,n)=>s!==t[n])?(this._colormapTexture=f(this._colormapTexture),this._colormapTexture=C(e,i),void(this._colormap=i)):void 0:(this._colormapTexture=C(e,i),void(this._colormap=i)):(this._colormapTexture=f(this._colormapTexture),void(this._colormap=null))}}const le=r=>{let e=class extends r{constructor(){super(...arguments),this._rasterFieldPrefix="Raster.",this.layer=null,this.view=null,this.tileInfo=null}get fullExtent(){return this._getfullExtent()}get timeExtent(){var t;return H(this.layer,(t=this.view)==null?void 0:t.timeExtent,this._get("timeExtent"))}get hasTilingEffects(){return!!(this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment)}get datumTransformation(){return J(this.layer.fullExtent,this.view.spatialReference,!0)}supportsSpatialReference(t){return!!v(this.layer.serviceRasterInfo,t)}async fetchPopupFeaturesAtLocation(t,i){var _;const{layer:s}=this;if(!t)throw new j("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:s});const{popupEnabled:n}=s,h=Y(s,i);if(!n||h==null)return[];const m=[],{value:a,magdirValue:l,processedValue:u}=await s.identify(t,{timeExtent:this.timeExtent,signal:i==null?void 0:i.signal});let o="";if(a!=null&&a.length){o=s.type==="imagery-tile"&&s.hasStandardTime()&&a[0]!=null?a.map(w=>s.getStandardTimeValue(w)).join(", "):a.join(", ");const c={ObjectId:0},I="Raster.ServicePixelValue";c[I]=s.type==="imagery-tile"&&s.raster.datasetFormat==="Function"?u==null?void 0:u.join(", "):o,c[I+".Raw"]=o;const x=((_=s.raster)==null?void 0:_.rasterInfo)??s.serviceRasterInfo,S=x==null?void 0:x.attributeTable;if(S!=null){const{fields:w,features:B}=S,A=w.find(({name:y})=>y.toLowerCase()==="value"),D=c[I],T=A?B.find(y=>String(y.attributes[A.name])===D):null;if(T)for(const y in T.attributes)T.attributes.hasOwnProperty(y)&&(c[this._rasterFieldPrefix+y]=T.attributes[y])}const P=x==null?void 0:x.dataType;P!=="vector-magdir"&&P!=="vector-uv"||(c["Raster.Magnitude"]=l==null?void 0:l[0],c["Raster.Direction"]=l==null?void 0:l[1]);const N=new V({geometry:this.fullExtent.clone(),attributes:c,layer:s,sourceLayer:s});m.push(N)}return m}_getfullExtent(){return v(this.layer.serviceRasterInfo,this.view.spatialReference)}};return d([p()],e.prototype,"fullExtent",null),d([p()],e.prototype,"layer",void 0),d([p({readOnly:!0})],e.prototype,"timeExtent",null),d([p()],e.prototype,"view",void 0),d([p()],e.prototype,"tileInfo",void 0),d([p({readOnly:!0})],e.prototype,"hasTilingEffects",null),d([p()],e.prototype,"datumTransformation",null),e=d([$("esri.views.layers.ImageryTileLayerView")],e),e};let g=class extends le(K(q(Z(Q)))){constructor(){super(...arguments),this.type="imagery-tile-3d",this._isAlignedMapTile=!0}initialize(){this.layer.increaseRasterJobHandlerUsage(),this.fullExtent==null&&this.addResolvingPromise(Promise.reject(new j("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const r=k(()=>{var e,t;return(t=(e=this.view)==null?void 0:e.basemapTerrain)==null?void 0:t.tilingSchemeLocked}).then(()=>{const e=this.view.basemapTerrain.tilingScheme,t=this.layer.tileInfo;this._isAlignedMapTile=["png","png24","png32","jpg","mixed"].includes(t.format)&&e.compatibleWith(t),this.tileInfo=this._isAlignedMapTile?t:e.toTileInfo(),this._updatingHandles.add(()=>[this.layer.renderer,this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent],()=>this.refresh())});this.addResolvingPromise(r)}destroy(){this.layer.decreaseRasterJobHandlerUsage()}get _blankTile(){const r=document.createElement("canvas"),e=r.getContext("2d"),[t,i]=this.tileInfo.size;return r.width=t,r.height=i,e.clearRect(0,0,t,i),e.getImageData(0,0,t,i)}get imageFormatIsOpaque(){return this.layer.tileInfo.format==="jpg"}get hasMixedImageFormats(){return this.layer.tileInfo.format==="mixed"}get dataLevelRange(){var i,s;const r=this.layer.tileInfo,e=(i=this.tileInfo.lodAt(0))==null?void 0:i.scale,t=(s=this.layer.tileInfo.lodAt(r.lods.length-1))==null?void 0:s.scale;return this.levelRangeFromScaleRange(e,t)}_getfullExtent(){var r;return v(this.layer.serviceRasterInfo,((r=this.view.basemapTerrain)==null?void 0:r.spatialReference)??this.view.spatialReference)}async fetchTile(r,e){const t=this.tileInfo,i=this._canSymbolizeInWebGL(),s={tileInfo:t,requestRawData:i,signal:e.signal,timeExtent:this.timeExtent,requestAsImageElement:this._isAlignedMapTile,noClip:!1},{layer:n}=this,[h,m,a]=r,l=await n.fetchTile(h,m,a,s);if(l instanceof HTMLImageElement)return l;let u=l==null?void 0:l.pixelBlock;if(u==null)return this._blankTile;if(!i&&(u=await n.applyRenderer(l),u==null))return this._blankTile;const o=new ne([h,m,a],u,t.size[0],t.size[1]);return i?(o.symbolizerRenderer=n.symbolizer.rendererJSON,o.symbolizerParameters=n.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(h)),o.transformGrid=l.transformGrid,o.bandIds=n.bandIds):(o.isRendereredSource=!0,o.bandIds=null),o.interpolation=n.interpolation,o}_getSymbolizerOptions(r){var t;const e=this.tileInfo.lodAt(r).resolution;return{pixelBlock:null,isGCS:((t=this.view.basemapTerrain)==null?void 0:t.spatialReference)!=null?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:e,y:e},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(r){this._canSymbolizeInWebGL()&&JSON.stringify(r.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(r.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(r.lij[0])))}createFetchPopupFeaturesQueryGeometry(r,e){return X(r,e,this.view)}refresh(){this.emit("data-changed")}async doRefresh(){this.suspended||this.emit("data-changed")}_canSymbolizeInWebGL(){var n,h,m;const r=W(),{symbolizer:e}=this.layer,t=(h=(n=e.lookup)==null?void 0:n.colormapLut)==null?void 0:h.indexedColormap,i=!!((m=this.layer.rasterFunction)!=null&&m.hasClipFunction),s=t&&t.length>4*(r.maxTextureSize||4906);return e.canRenderInWebGL&&!s&&!i}};d([p({readOnly:!0})],g.prototype,"_blankTile",null),d([p({readOnly:!0})],g.prototype,"imageFormatIsOpaque",null),d([p({readOnly:!0})],g.prototype,"hasMixedImageFormats",null),d([p({readOnly:!0})],g.prototype,"dataLevelRange",null),g=d([$("esri.views.3d.layers.ImageryTileLayerView3D")],g);const ge=g;export{ge as default};
