import{e as o,y as m,k as c,s as v,G as D,a6 as E,cj as u,gV as _,bm as b}from"./index-r0Ml_rWi.js";import{N as H}from"./DynamicLayerView3D-CnHc6E8P.js";import{i as I}from"./timeSupport-W1jIjBlk.js";import{p as P}from"./popupUtils-Di_dO6dW.js";import"./LayerView3D-D72Vr-Z0.js";import"./projectExtentUtils-BJMekKNv.js";import"./ImageMaterial.glsl-DEJugBmr.js";import"./LayerView-DKnidSo3.js";import"./RefreshableLayerView-DIAp9UEp.js";const F=e=>{let t=class extends e{constructor(){super(...arguments),this.view=null}get timeExtent(){var a;return I(this.layer,(a=this.view)==null?void 0:a.timeExtent,this._get("timeExtent"))}async fetchPopupFeaturesAtLocation(a,i){const{layer:r}=this;if(!a)throw new v("imagerylayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:r});const{popupEnabled:s}=r,n=P(r,i);if(!s||n==null)return[];const g=await n.getRequiredFields();D(i);const l=new E;l.timeExtent=this.timeExtent,l.geometry=a,l.outFields=g,l.outSpatialReference=a.spatialReference;const{resolution:d,spatialReference:h}=this.view,y=this.view.type==="2d"?new u(d,d,h):new u(.5*d,.5*d,h),{returnTopmostRaster:w,showNoDataRecords:x}=n.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},f={returnDomainValues:!0,returnTopmostRaster:w,pixelSize:y,showNoDataRecords:x,signal:i==null?void 0:i.signal};return r.queryVisibleRasters(l,f).then(R=>R)}canResume(){var a;return!!super.canResume()&&!((a=this.timeExtent)!=null&&a.isEmpty)}};return o([m()],t.prototype,"layer",void 0),o([m()],t.prototype,"suspended",void 0),o([m({readOnly:!0})],t.prototype,"timeExtent",null),o([m()],t.prototype,"view",void 0),t=o([c("esri.views.layers.ImageryLayerView")],t),t};let p=class extends F(H){constructor(){super(...arguments),this.type="imagery-3d",this.redrawDebounced=_(async e=>{this.redraw((t,a)=>this._redrawImage(t,a),e)},2e3)}initialize(){this.addHandles([b(()=>this.view.basemapTerrain.ready,()=>this._initializeMaximumDataResolution(),{once:!0,initial:!0}),this.layer.on("redraw",()=>this._updatingHandles.addPromise(this.redrawDebounced()))]),this._updatingHandles.add(()=>{var e,t;return(t=(e=this.layer)==null?void 0:e.exportImageServiceParameters)==null?void 0:t.version},()=>{this._updatingHandles.addPromise(this.refreshDebounced())}),this._updatingHandles.add(()=>{var e;return(e=this.layer)==null?void 0:e.renderer},()=>{this._updatingHandles.addPromise(this.refreshDebounced())}),this._updatingHandles.add(()=>this.timeExtent,()=>this._updatingHandles.addPromise(this.refreshDebounced()))}_initializeMaximumDataResolution(){this.maximumDataResolution=this.layer.loaded?this.layer.serviceRasterInfo.pixelSize:null}getFetchOptions(){return{timeExtent:this.timeExtent}}async processResult(e,t,a){t.imageOrCanvasElement?e.image=t.imageOrCanvasElement:(e.image=document.createElement("canvas"),e.pixelData=t.pixelData,await this._redrawImage(e,a))}async _redrawImage(e,t){if(!(e.image instanceof HTMLCanvasElement)||e.pixelData==null)throw new Error;const a=e.image,i=a.getContext("2d"),r=await this.layer.applyRenderer(e.pixelData,{signal:t}),s=this.layer.applyFilter(r).pixelBlock;if(s==null)throw new Error;a.width=s.width,a.height=s.height;const n=i.createImageData(s.width,s.height);n.data.set(s.getAsRGBA()),i.putImageData(n,0,0)}};p=o([c("esri.views.3d.layers.ImageryLayerView3D")],p);const k=p;export{k as default};
